<html>
	<head>
		<link href='http://fonts.googleapis.com/css?family=Ruda:400,900,700' rel='stylesheet' type='text/css'>
		<link type="text/css" rel="stylesheet" href="css/reset.css">
		<link type="text/css" rel="stylesheet" href="css/process.css">
		<link type="text/css" rel="stylesheet" href="css/global-styles.css">
	</head>
	<body>
	
	<div id="process">
		<h1>Not-so-fast food</h1>
		<h4>It takes, on average, about four months (or 120 days) for a shipment of international food aid to make its way from America to hungry people overseas. Follow this shipment, an order of corn soy blend for a Save the Children aid program in Niger, on its nearly 6,000 mile journey.</h4>
		<div id="wrapper" class="clearfix">
			<div id="map"></div>
			
			<div id="text">
				<div class="nav" class="clearfix">
					<p id="next"><img src="images/arrow-button-right.png" width="35px"></img></p>
					<p id="prev"><img src="images/arrow-button-left.png" width="35px"></img></p>
					<div id="steps" class="clearfix"></div>
				</div>
				<h4>Day:&nbsp;&nbsp;<span id="days"></span></h4>
				<h2 id="headline"></h2>
				<p id="location"></p>
				<p id="body" class="body"></p>
			</div>
		</div>
		<p id="source">Source: CMA-CGM, Save the Children, USDA. Credit: Darla Cameron, Laurel White, Kate Van Winkle & Kennedy Elliot</p>
	</div>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script src="data/process-text.js"></script>
		<script src="data/path_points.js"></script>
		<script>

			var counter = 0,
				animating = false;
			
			var width = 900,
				height = 500;

			var projection = d3.geo.mercator()
				.center([-12.949707, 26.358221])
				.scale(310);

			var pathFunc = d3.geo.path().projection(projection);

			var svg = d3.select("#map").append("svg")
				.attr("width", width)
				.attr("height", height)
				.append('g');
			
			d3.json("data/world-us-lakes-topo.json", function(error, world) {
			  	
			  	var subunits = topojson.feature(world, world.objects.subunits).features,
			  	subunitsMesh = topojson.mesh(world, world.objects.subunits, function(a, b) { return a !== b; }),
			  	states = topojson.feature(world, world.objects.states).features,
				statesMesh = topojson.mesh(world, world.objects.states, function(a, b) { return a !== b; }),
				lakes = topojson.feature(world, world.objects.lakes).features;


			    svg.selectAll(".subunit")
				      .data(subunits)
				      .enter().append("path")
				      .attr("class", function(d) { return "country " + convertToSlug(d.properties.name); })
				      //.attr('title', function(d){return "title"})
				      .attr("d", pathFunc);

				svg.selectAll(".states")
				      .data(states)
				      .enter().append("path")
				      .attr("class", function(d) { return "state " + convertToSlug(d.properties.name); })
				      .attr("d", pathFunc);

				svg.selectAll(".lakes")
				      .data(lakes)
				      .enter().append("path")
				      .attr("class", function(d) { return "lake " + convertToSlug(d.properties.name); })
				      .attr("d", pathFunc);

			    svg.append("path")
			        .datum(subunitsMesh)
			        .attr("class", "boundary")
			        .attr("d", pathFunc);

			    svg.append("path")
			        .datum(statesMesh)
			        .attr("class", "boundary")
			        .attr("d", pathFunc);
				writeText();
			});

			function drawLine(direction) {
				if (counter === 0) {
					d3.selectAll('.points').remove();
				} else {
					animating = true;

					var path = svg.append('path')
						.attr('class', 'points')
						.attr('id', 'point-' + counter)
						.attr('d', pathFunc(pathPoints[counter]));

					var totalLength = path.node().getTotalLength();

					if (direction === 'next') {
						animatePath(path, totalLength, totalLength, 0);
					} else {
						animatePath(path, totalLength, 0, totalLength);
					}
					
				}
			}

			var animatePath = function(obj, total, beginning, end) {
				obj.attr("stroke-dasharray", total + " " + total)
				    .attr("stroke-dashoffset", beginning)
				    .transition()
				    .duration(1000)
				    .ease("linear")
				    .attr("stroke-dashoffset", end)
				    .each('end', function() {
				    	animating = false;
				    });
			};
			
			function writeText() {
				$('#headline').text(process_text[counter].headline);
				// $('#body').text(process_text[counter].body);
				$('#location').text(process_text[counter].location);
				$('#days').text(process_text[counter].days);

				var $body = $('#body');
				$body.text('');
				$.each(process_text[counter].body, function(i, sentence) {
					var $sentence = $('<div class="body">');
					$sentence.text(sentence);
					$body.append($sentence);
				});
			}
			
			function timeLapsed() {
				$('#time').text(counter);
			}

			$('#next').on('click', function() {
				if (animating) {
					return;
				}

				if (counter === pathPoints.length - 1) {
					counter = 0;
				} else {
					counter += 1;
				}
				
				drawLine('next');
				writeText();
			});

			$('#prev').on('click', function() {
				if (animating) {
					return;
				}

				$('#point-' + counter).remove();
				drawLine('prev');
				
				writeText();

				if (counter === 0) {
					counter = pathPoints.length - 1;
				} else {
					counter -= 1;
				}
			});


			function clicked(d) {
			  var x, y, k;

			  if (d && centered !== d) {
			    // var centroid = pathFunc.centroid(d);
			    var centroid = [87.976074, 80.733377];
			    x = centroid[0];
			    y = centroid[1];
			    k = 10;
			    centered = d;
			  } else {
			    x = width / 2;
			    y = height / 2;
			    k = 1;
			    centered = null;
			  }

			  g.selectAll("path")
			      .classed("active", centered && function(d) { return d === centered; });

			  g.transition()
			      .duration(750)
			      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
			      .style("stroke-width", 1.5 / k + "px");

			  d3.selectAll('path.points').style('stroke-width', 1 / k + 'px');
			}
			
			function convertToSlug(Text)
				{
				    return Text
				        .toLowerCase()
				        .replace(/[^\w ]+/g,'')
				        .replace(/ +/g,'-')
				        ;
				}

			function makeCircles(){
				var $steps = $('#steps');
				$.each(process_text, function(i, dp) {
					var $circle = $('<div class="circle">');
					$steps.append($circle);
				});
			}
			makeCircles();

		</script>
	</body>
</html>